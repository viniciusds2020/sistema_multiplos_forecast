{% extends "base.html" %}
{% set active_page = "similarity" %}
{% block title %}Similaridade - ForecastForge{% endblock %}

{% block content %}
<div class="fade-in">
    <h1 class="text-2xl font-extrabold text-gray-900 tracking-tight">Análise de Similaridade</h1>
    <p class="text-sm text-gray-400 mt-1">Identifique padroes semelhantes entre SKUs e agrupe-os em clusters</p>
    <div class="h-px bg-gradient-to-r from-brand-500/40 to-transparent mt-4 mb-6"></div>

    <!-- Controls -->
    <div class="card p-4 mb-6">
        <div class="flex flex-wrap items-center gap-6">
            <div>
                <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Metrica</label>
                <select id="sel-metric" class="mt-1 block w-44 rounded-lg border border-gray-200 px-3 py-2 text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500">
                    <option value="pearson" selected>Pearson</option>
                    <option value="euclidean">Euclidean</option>
                    <option value="dtw">DTW</option>
                </select>
            </div>
            <div class="flex items-center gap-3">
                <label class="flex items-center gap-2 text-sm font-medium text-gray-600">
                    <input type="checkbox" id="chk-auto-k" checked class="rounded border-gray-300 text-brand-500 focus:ring-brand-500"> K automatico
                </label>
                <input type="number" id="inp-k" min="2" max="8" value="4" disabled
                       class="w-16 rounded-lg border border-gray-200 px-2 py-2 text-sm text-center disabled:opacity-40">
            </div>
            <button onclick="runClustering()" class="ml-auto px-5 py-2.5 bg-gradient-to-r from-brand-500 to-brand-600 text-white text-sm font-semibold rounded-lg shadow-md shadow-brand-500/30 hover:shadow-lg hover:-translate-y-0.5 transition-all">
                Executar Clustering
            </button>
        </div>
    </div>

    <!-- KPIs -->
    <div id="sim-kpis" class="grid grid-cols-3 gap-4 mb-8"></div>

    <!-- Row 1: Heatmap + Silhouette -->
    <div id="sim-results" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="card p-5">
                <h3 class="text-sm font-bold text-gray-700 mb-3 pb-2 border-b border-gray-100">Matriz de Distância</h3>
                <div id="chart-dist" class="plotly-chart"></div>
            </div>
            <div class="card p-5">
                <h3 class="text-sm font-bold text-gray-700 mb-3 pb-2 border-b border-gray-100">Silhouette Score por K</h3>
                <div id="chart-sil" class="plotly-chart"></div>
            </div>
        </div>

        <!-- Row 2: MDS + Dendrograma -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="card p-5">
                <h3 class="text-sm font-bold text-gray-700 mb-3 pb-2 border-b border-gray-100">Projeção MDS 2D</h3>
                <div id="chart-mds" class="plotly-chart"></div>
            </div>
            <div class="card p-5">
                <h3 class="text-sm font-bold text-gray-700 mb-3 pb-2 border-b border-gray-100">Dendrograma Hierárquico</h3>
                <div id="chart-dendro" class="plotly-chart"></div>
            </div>
        </div>

        <!-- Cluster detail -->
        <div class="card p-5 mb-8">
            <div class="flex items-center gap-4 mb-4">
                <h3 class="text-sm font-bold text-gray-700">Detalhe do Cluster</h3>
                <select id="sel-cluster" onchange="showClusterDetail()" class="rounded-lg border border-gray-200 px-3 py-1.5 text-sm"></select>
            </div>
            <div id="chart-cluster-detail" class="plotly-chart mb-4"></div>
            <div id="cluster-summary-table" class="overflow-x-auto"></div>
        </div>
    </div>

    <!-- Loading -->
    <div id="sim-loading" class="hidden flex items-center justify-center py-20">
        <div class="spinner"></div><span class="ml-3 text-gray-400">Calculando clusters...</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let simData = null;

document.getElementById('chk-auto-k').addEventListener('change', e => {
    document.getElementById('inp-k').disabled = e.target.checked;
});

async function runClustering() {
    const metric = document.getElementById('sel-metric').value;
    const autoK = document.getElementById('chk-auto-k').checked;
    const manualK = parseInt(document.getElementById('inp-k').value) || 4;

    document.getElementById('sim-results').classList.add('hidden');
    document.getElementById('sim-loading').classList.remove('hidden');

    simData = await postJson('/api/similarity/run', { metric, auto_k: autoK, manual_k: manualK });

    document.getElementById('sim-loading').classList.add('hidden');

    if (!simData || simData.error) {
        document.getElementById('sim-kpis').innerHTML = '';
        showError('sim-kpis', simData?.error || 'Erro ao executar clustering');
        return;
    }

    document.getElementById('sim-results').classList.remove('hidden');

    // KPIs
    document.getElementById('sim-kpis').innerHTML = `
        ${kpiHtml('Clusters', simData.n_clusters, '#4361ee')}
        ${kpiHtml('Silhouette', simData.sil_best, '#06d6a0')}
        ${kpiHtml('Total SKUs', simData.total_skus, '#118ab2')}
    `;

    if (simData.charts) {
        renderPlotly('chart-dist', simData.charts.dist_heatmap);
        renderPlotly('chart-sil', simData.charts.silhouette);
        renderPlotly('chart-mds', simData.charts.mds);
        renderPlotly('chart-dendro', simData.charts.dendro);
    }

    // Populate cluster selector
    const sel = document.getElementById('sel-cluster');
    const clusterKeys = simData.charts?.cluster_series ? Object.keys(simData.charts.cluster_series) : [];
    sel.innerHTML = clusterKeys.map(c => `<option value="${c}">Cluster ${c}</option>`).join('');
    if (clusterKeys.length) showClusterDetail();
}

function showClusterDetail() {
    if (!simData) return;
    const c = document.getElementById('sel-cluster').value;
    renderPlotly('chart-cluster-detail', simData.charts.cluster_series[c]);

    // Summary table
    const rows = simData.summary.filter(r => String(r.cluster) === c);
    let html = `<table class="w-full text-sm"><thead><tr class="text-left text-xs font-semibold text-gray-400 uppercase tracking-wider border-b">
        <th class="pb-2 pr-4">SKU</th><th class="pb-2 pr-4">Nome</th><th class="pb-2 pr-4">Perfil</th>
        <th class="pb-2 pr-4">Media</th><th class="pb-2 pr-4">CV</th><th class="pb-2">% Zeros</th>
    </tr></thead><tbody>`;
    rows.forEach(r => {
        html += `<tr class="border-b border-gray-50 hover:bg-gray-50/50">
            <td class="py-2 pr-4 font-mono text-xs">${r.sku_id}</td>
            <td class="py-2 pr-4 font-medium">${r.sku_name}</td>
            <td class="py-2 pr-4"><span class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase bg-brand-50 text-brand-600">${r.demand_profile}</span></td>
            <td class="py-2 pr-4">${r.mean_demand}</td>
            <td class="py-2 pr-4">${r.cv}</td>
            <td class="py-2">${r.zero_pct}%</td>
        </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('cluster-summary-table').innerHTML = html;
}
</script>
{% endblock %}
