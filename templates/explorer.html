{% extends "base.html" %}
{% set active_page = "explorer" %}
{% block title %}Data Explorer - Forecast Pro{% endblock %}

{% block content %}
<div class="fade-in">
    <h1 class="text-2xl font-extrabold text-gray-900 tracking-tight">Data Explorer</h1>
    <p class="text-sm text-gray-400 mt-1">Explore as series temporais, dados climaticos e features</p>
    <div class="h-px bg-gradient-to-r from-brand-500/40 to-transparent mt-4 mb-6"></div>

    <!-- SKU selector -->
    <div class="card p-4 mb-6">
        <div class="flex flex-wrap items-center gap-3">
            <label class="text-sm font-semibold text-gray-600">SKUs:</label>
            <div id="sku-chips" class="flex flex-wrap gap-2"></div>
            <button onclick="loadDemand()" class="ml-auto px-4 py-2 bg-gradient-to-r from-brand-500 to-brand-600 text-white text-sm font-semibold rounded-lg shadow-md shadow-brand-500/30 hover:shadow-lg hover:-translate-y-0.5 transition-all">
                Atualizar
            </button>
        </div>
    </div>

    <!-- Tabs -->
    <div class="flex gap-1 bg-gray-100 rounded-xl p-1 mb-6">
        <button onclick="switchTab('demand')" class="tab-btn active flex-1 py-2.5 text-sm font-semibold rounded-lg text-gray-500" data-tab="demand">Series de Demanda</button>
        <button onclick="switchTab('climate')" class="tab-btn flex-1 py-2.5 text-sm font-semibold rounded-lg text-gray-500" data-tab="climate">Dados Climaticos</button>
        <button onclick="switchTab('dist')" class="tab-btn flex-1 py-2.5 text-sm font-semibold rounded-lg text-gray-500" data-tab="dist">Distribuicoes</button>
        <button onclick="switchTab('raw')" class="tab-btn flex-1 py-2.5 text-sm font-semibold rounded-lg text-gray-500" data-tab="raw">Dados Brutos</button>
    </div>

    <!-- Tab contents -->
    <div id="tab-demand" class="tab-content">
        <div class="card p-5">
            <h3 class="text-sm font-bold text-gray-700 mb-3 pb-2 border-b border-gray-100">Series de Demanda por SKU</h3>
            <div id="chart-demand" class="plotly-chart"></div>
        </div>
    </div>

    <div id="tab-climate" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="card p-5"><div id="chart-temp" class="plotly-chart"></div></div>
            <div class="card p-5"><div id="chart-rain" class="plotly-chart"></div></div>
        </div>
        <div class="card p-5"><div id="chart-hum" class="plotly-chart"></div></div>
    </div>

    <div id="tab-dist" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card p-5"><div id="chart-season" class="plotly-chart"></div></div>
            <div class="card p-5"><div id="chart-dow" class="plotly-chart"></div></div>
            <div class="card p-5"><div id="chart-safra" class="plotly-chart"></div></div>
            <div class="card p-5"><div id="chart-profile" class="plotly-chart"></div></div>
        </div>
    </div>

    <div id="tab-raw" class="tab-content hidden">
        <div class="card p-5">
            <h3 class="text-sm font-bold text-gray-700 mb-3 pb-2 border-b border-gray-100">Dados Brutos (primeiros 300 registros)</h3>
            <div id="raw-table" class="overflow-x-auto"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allSkus = [];
let selectedSkus = new Set();
let loaded = { demand:false, climate:false, dist:false, raw:false };

function switchTab(name) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
    document.getElementById('tab-'+name).classList.remove('hidden');
    document.querySelector(`[data-tab="${name}"]`).classList.add('active');
    if (!loaded[name]) { loadTabData(name); loaded[name] = true; }
}

async function loadTabData(name) {
    if (name === 'climate') {
        const d = await fetchJson('/api/explorer/climate');
        if (!d || d.error) { showError('chart-temp', d?.error || 'Erro ao carregar'); return; }
        renderPlotly('chart-temp', d.temperature);
        renderPlotly('chart-rain', d.rainfall);
        renderPlotly('chart-hum', d.humidity);
    } else if (name === 'dist') {
        const d = await fetchJson('/api/explorer/distributions');
        if (!d || d.error) { showError('chart-season', d?.error || 'Erro ao carregar'); return; }
        renderPlotly('chart-season', d.season);
        renderPlotly('chart-dow', d.dow);
        renderPlotly('chart-safra', d.safra);
        renderPlotly('chart-profile', d.profile);
    } else if (name === 'raw') {
        const rows = await fetchJson('/api/explorer/raw');
        if (!rows || rows.error || !rows.length) { showError('raw-table', rows?.error || 'Sem dados'); return; }
        const cols = Object.keys(rows[0]);
        let html = `<table class="w-full text-xs"><thead><tr class="text-left text-[10px] font-semibold text-gray-400 uppercase tracking-wider border-b">`;
        cols.forEach(c => html += `<th class="pb-2 pr-3 whitespace-nowrap">${c}</th>`);
        html += '</tr></thead><tbody>';
        rows.forEach(r => {
            html += '<tr class="border-b border-gray-50 hover:bg-gray-50/50">';
            cols.forEach(c => html += `<td class="py-1.5 pr-3 whitespace-nowrap">${r[c] ?? ''}</td>`);
            html += '</tr>';
        });
        html += '</tbody></table>';
        document.getElementById('raw-table').innerHTML = html;
    }
}

async function loadDemand() {
    const skus = Array.from(selectedSkus);
    if (!skus.length) { showError('chart-demand', 'Selecione ao menos 1 SKU'); return; }
    const params = skus.map(s => `skus=${encodeURIComponent(s)}`).join('&');
    showLoading(document.getElementById('chart-demand'));
    const d = await fetchJson('/api/explorer/demand?' + params);
    if (!d || d.error) { showError('chart-demand', d?.error || 'Erro ao carregar'); return; }
    renderPlotly('chart-demand', d.chart);
}

function toggleSku(name) {
    selectedSkus.has(name) ? selectedSkus.delete(name) : selectedSkus.add(name);
    renderChips();
}

function renderChips() {
    const el = document.getElementById('sku-chips');
    el.innerHTML = allSkus.map(s => `
        <button onclick="toggleSku('${s.sku_name}')"
                class="px-3 py-1 rounded-full text-xs font-semibold transition-all ${
                    selectedSkus.has(s.sku_name)
                    ? 'bg-brand-500 text-white shadow-sm' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}">
            ${s.sku_name}
        </button>
    `).join('');
}

document.addEventListener('DOMContentLoaded', async () => {
    allSkus = await fetchJson('/api/skus');
    if (!allSkus || allSkus.error) { allSkus = []; showError('chart-demand', 'Erro ao carregar SKUs'); return; }
    allSkus.slice(0,4).forEach(s => selectedSkus.add(s.sku_name));
    renderChips();
    loadDemand();
    loaded.demand = true;
});
</script>
{% endblock %}
