{% extends "base.html" %}
{% set active_page = "overview" %}
{% block title %}Overview - Forecast Pro{% endblock %}

{% block content %}
<div class="fade-in">
    <h1 class="text-2xl font-extrabold text-gray-900 tracking-tight">Dashboard Overview</h1>
    <p class="text-sm text-gray-400 mt-1">Visao geral do sistema de forecast multi-produto SKU</p>
    <div class="h-px bg-gradient-to-r from-brand-500/40 to-transparent mt-4 mb-6"></div>

    <!-- KPIs -->
    <div id="kpis" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8"></div>

    <!-- Heatmap + Top SKUs -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
        <div class="lg:col-span-3 card p-5">
            <h3 class="text-sm font-bold text-gray-700 mb-3 pb-2 border-b border-gray-100">Heatmap de Demanda - SKU x Mes</h3>
            <div id="chart-heatmap" class="plotly-chart"></div>
        </div>
        <div class="lg:col-span-2 card p-5">
            <h3 class="text-sm font-bold text-gray-700 mb-3 pb-2 border-b border-gray-100">Top 10 SKUs por Volume</h3>
            <div id="chart-top" class="plotly-chart"></div>
        </div>
    </div>

    <!-- Total demand + Profiles -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
        <div class="lg:col-span-3 card p-5">
            <h3 class="text-sm font-bold text-gray-700 mb-3 pb-2 border-b border-gray-100">Demanda Total Agregada</h3>
            <div id="chart-total" class="plotly-chart"></div>
        </div>
        <div class="lg:col-span-2 card p-5">
            <h3 class="text-sm font-bold text-gray-700 mb-3 pb-2 border-b border-gray-100">Distribuicao por Perfil</h3>
            <div id="chart-profiles" class="plotly-chart"></div>
        </div>
    </div>

    <!-- Stats table -->
    <div class="card p-5">
        <h3 class="text-sm font-bold text-gray-700 mb-3 pb-2 border-b border-gray-100">Estatisticas por Perfil de Demanda</h3>
        <div id="stats-table" class="overflow-x-auto"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    // KPIs
    const kpis = await fetchJson('/api/kpis');
    if (kpis && !kpis.error) {
        document.getElementById('kpis').innerHTML = `
            ${kpiHtml('Total SKUs', kpis.total_skus, '#4361ee')}
            ${kpiHtml('Registros', kpis.total_records.toLocaleString(), '#06d6a0')}
            ${kpiHtml('Cobertura', kpis.coverage_days + ' dias', '#118ab2')}
            ${kpiHtml('Demanda Media', kpis.avg_demand + ' un/dia', '#ffd166')}
        `;
    }

    // Charts
    const data = await fetchJson('/api/overview/charts');
    if (!data || data.error) { showError('chart-heatmap', data?.error || 'Erro ao carregar'); return; }
    renderPlotly('chart-heatmap', data.heatmap);
    renderPlotly('chart-top', data.top_skus);
    renderPlotly('chart-total', data.total_demand);
    renderPlotly('chart-profiles', data.profiles);

    // Stats table
    const rows = data.stats_table;
    let html = `<table class="w-full text-sm">
        <thead><tr class="text-left text-xs font-semibold text-gray-400 uppercase tracking-wider border-b border-gray-100">
            <th class="pb-3 pr-4">Perfil</th><th class="pb-3 pr-4">SKUs</th><th class="pb-3 pr-4">Media</th>
            <th class="pb-3 pr-4">Desvio</th><th class="pb-3 pr-4">Maximo</th><th class="pb-3">% Zeros</th>
        </tr></thead><tbody>`;
    rows.forEach(r => {
        html += `<tr class="border-b border-gray-50 hover:bg-gray-50/50">
            <td class="py-2.5 pr-4 font-medium">${r.demand_profile}</td>
            <td class="py-2.5 pr-4">${r.skus}</td><td class="py-2.5 pr-4">${r.media}</td>
            <td class="py-2.5 pr-4">${r.desvio}</td><td class="py-2.5 pr-4">${r.maximo}</td>
            <td class="py-2.5">${r.zero_pct}%</td>
        </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('stats-table').innerHTML = html;
});
</script>
{% endblock %}
